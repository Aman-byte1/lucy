<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lucy AI | Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        :root { 
            --primary-color: #4F46E5; 
            --bg-color: #f8fafc; 
            --sidebar-width: 280px;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); height: 100vh; overflow: hidden; color: var(--text-main); }
        
        /* Layout */
        .wrapper { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { 
            width: var(--sidebar-width); 
            background: white; 
            border-right: 1px solid #e2e8f0; 
            display: flex; 
            flex-direction: column; 
            padding: 24px;
            z-index: 10;
        }
        .brand { font-weight: 700; font-size: 1.25rem; color: var(--primary-color); display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
        .nav-item { margin-bottom: 4px; }
        .nav-link { 
            color: var(--text-muted); 
            font-weight: 500; 
            padding: 12px 16px; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: all 0.2s; 
        }
        .nav-link:hover { background: #f1f5f9; color: var(--text-main); }
        .nav-link.active { background: #e0e7ff; color: var(--primary-color); }
        .nav-link i { font-size: 1.1rem; }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; padding: 40px; display: flex; gap: 40px; justify-content: center; }
        .config-area { width: 100%; max-width: 600px; }
        .preview-area { width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: sticky; top: 40px; height: fit-content; }

        /* Forms */
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 24px; background: white; }
        .card-header { background: white; border-bottom: 1px solid #f1f5f9; padding: 20px 24px; font-weight: 600; border-radius: 16px 16px 0 0; }
        .card-body { padding: 24px; }
        
        .form-label { font-size: 0.85rem; font-weight: 600; color: #334155; margin-bottom: 6px; }
        .form-control, .form-select { 
            border-radius: 8px; 
            border: 1px solid #cbd5e1; 
            padding: 10px 14px; 
            font-size: 0.95rem; 
            transition: border 0.2s;
        }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        textarea.form-control { font-family: 'Menlo', monospace; font-size: 0.85rem; background: #f8fafc; }

        /* Phone Preview */
        .phone-frame {
            width: 360px;
            height: 700px;
            background: #fff;
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 8px solid #1e293b;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .phone-notch {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 120px; height: 24px; background: #1e293b;
            border-radius: 0 0 16px 16px; z-index: 20;
        }
        .chat-app { flex: 1; display: flex; flex-direction: column; background: #f8fafc; overflow: hidden; margin-top: 24px; }
        .chat-header { padding: 16px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg { padding: 10px 14px; border-radius: 14px; font-size: 0.9rem; line-height: 1.4; max-width: 80%; }
        .msg.user { background: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg.assistant { background: white; color: #1e293b; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; }
        
        .chat-input { padding: 12px; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 8px; }
        
        /* Toast */
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 100; }
        
        /* Activity Log */
        .log-item { padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .log-item:last-child { border-bottom: none; }
        .log-query { font-weight: 500; font-size: 0.9rem; margin-bottom: 4px; }
        .log-meta { font-size: 0.75rem; color: #94a3b8; }
        
        /* Upload Box */
        .upload-box { 
            border: 2px dashed #cbd5e1; border-radius: 12px; padding: 24px; 
            text-align: center; cursor: pointer; transition: all 0.2s; background: #f8fafc;
        }
        .upload-box:hover { border-color: var(--primary-color); background: #e0e7ff; }
    </style>
</head>
<body>

<div class="wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand"><i class="bi bi-robot"></i> Lucy AI</div>
        
        <nav class="nav flex-column nav-pills" role="tablist">
            <a class="nav-link active" data-bs-toggle="pill" href="#tab-knowledge">
                <i class="bi bi-book"></i> Knowledge Base
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#tab-settings">
                <i class="bi bi-sliders"></i> Settings
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#tab-activity" onclick="loadActivity()">
                <i class="bi bi-activity"></i> Activity
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#tab-embed">
                <i class="bi bi-code-slash"></i> Integration
            </a>
        </nav>

        <div class="mt-auto pt-4 border-top">
            <div class="d-flex align-items-center justify-content-between">
                <div class="small fw-medium text-muted">Account</div>
                <a href="/logout" class="text-danger small text-decoration-none"><i class="bi bi-box-arrow-right"></i> Logout</a>
            </div>
        </div>
    </aside>

    <!-- Content -->
    <main class="main-content">
        <!-- Configuration Column -->
        <div class="config-area">
            <div class="tab-content">
                <!-- Knowledge Tab -->
                <div class="tab-pane fade show active" id="tab-knowledge">
                    <h3 class="fw-bold mb-4">Knowledge Base</h3>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Text Source</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('kbText').value=''">Clear</button>
                        </div>
                        <div class="card-body">
                            <textarea id="kbText" class="form-control mb-3" rows="12" placeholder="Paste your training data, FAQs, or policies here..."></textarea>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted"><i class="bi bi-info-circle"></i> Lucy answers based on this text.</small>
                                <span class="badge bg-light text-dark border">Text</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">File Import</div>
                        <div class="card-body">
                            <div class="upload-box" onclick="document.getElementById('fileUpload').click()">
                                <i class="bi bi-cloud-upload fs-3 text-primary mb-2"></i>
                                <div class="fw-medium">Click to Upload PDF/TXT</div>
                                <small class="text-muted">Max 5MB</small>
                                <input type="file" id="fileUpload" class="d-none" onchange="uploadFile()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="tab-settings">
                    <h3 class="fw-bold mb-4">Bot Settings</h3>
                    
                    <div class="card">
                        <div class="card-header">Appearance</div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">Bot Name</label>
                                    <input type="text" id="botName" class="form-control" placeholder="Lucy Support">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Accent Color</label>
                                    <input type="color" id="themeColor" class="form-control form-control-color w-100" value="#4F46E5">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">AI Configuration</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Model</label>
                                <select id="aiModel" class="form-select">
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fastest)</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (Best Quality)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">
                                    <span>Creativity (Temperature)</span>
                                    <span id="tempValue" class="text-muted small">0.7</span>
                                </label>
                                <input type="range" class="form-range" id="aiTemp" min="0" max="1" step="0.1" value="0.7" oninput="document.getElementById('tempValue').innerText=this.value">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">System Prompt</label>
                                <textarea id="sysPrompt" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Welcome Message</label>
                                <input type="text" id="welcomeMsg" class="form-control">
                            </div>
                        </div>
                    </div>
                    
                    <div class="card bg-light border-0">
                        <div class="card-body">
                            <label class="form-label text-muted small text-uppercase">API Key</label>
                            <div class="input-group">
                                <input type="text" id="apiKey" class="form-control font-monospace bg-white" readonly>
                                <button class="btn btn-outline-secondary bg-white" onclick="generateNewKey()"><i class="bi bi-arrow-clockwise"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div class="tab-pane fade" id="tab-activity">
                    <h3 class="fw-bold mb-4">Recent Activity</h3>
                    <div class="card">
                        <div class="card-body" id="activityList">
                            <p class="text-muted text-center py-4">Loading activity...</p>
                        </div>
                    </div>
                </div>

                <!-- Embed Tab -->
                <div class="tab-pane fade" id="tab-embed">
                    <h3 class="fw-bold mb-4">Integration</h3>
                    <div class="card">
                        <div class="card-body">
                            <p class="mb-3">Paste this snippet before the closing <code>&lt;/body&gt;</code> tag on your website.</p>
                            <textarea id="embedCode" class="form-control font-monospace bg-dark text-white border-0 p-3" rows="8" readonly></textarea>
                            <button class="btn btn-outline-primary w-100 mt-3" onclick="navigator.clipboard.writeText(document.getElementById('embedCode').value)">
                                <i class="bi bi-clipboard me-2"></i>Copy Code
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global Save Button -->
            <button id="saveBtn" class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm position-sticky bottom-0">
                Save Changes
            </button>
        </div>

        <!-- Phone Preview -->
        <div class="preview-area d-none d-xl-flex">
            <div class="phone-frame">
                <div class="phone-notch"></div>
                <div class="chat-app">
                    <div class="chat-header">
                        <div class="d-flex align-items-center gap-2">
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width:32px; height:32px; color:var(--primary-color)">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="fw-bold fs-6" id="previewName">Lucy AI</div>
                        </div>
                        <i class="bi bi-three-dots text-muted"></i>
                    </div>
                    <div id="messages" class="chat-messages">
                        <!-- Preview messages -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="userInput" class="form-control rounded-pill border-0 bg-light" placeholder="Message...">
                        <button id="sendBtn" class="btn btn-primary rounded-circle" style="width:38px; height:38px; padding:0"><i class="bi bi-send-fill"></i></button>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4 text-muted small">
                <i class="bi bi-eye"></i> Live Mobile Preview
            </div>
        </div>
    </main>
</div>

<!-- Toast -->
<div class="toast-container">
    <div id="saveToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i> Settings saved successfully!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_SETTINGS = "/api/settings";
    const API_SUPPORT = "/api/support";
    const API_UPLOAD = "/api/upload";
    const API_ACTIVITY = "/api/activity";
    
    let currentConfig = {};

    // --- Config Logic ---
    async function uploadFile() {
        const input = document.getElementById('fileUpload');
        const file = input.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const res = await fetch(API_UPLOAD, { method: 'POST', body: formData });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            
            const kb = document.getElementById('kbText');
            kb.value = (kb.value + "\n\n" + `--- ${data.filename} ---\n` + data.extracted_text).trim();
            showToast("File imported successfully!");
            input.value = "";
        } catch (e) {
            alert("Upload failed: " + e.message);
        }
    }

    function updateEmbedCode(key) {
        const code = `<script src="${window.location.origin}/static/widget.js"><\/script>\n<script>\n  window.__LUCY_CLIENT_KEY__ = "${key}";\n<\/script>`;
        document.getElementById('embedCode').value = code;
    }

    function generateNewKey() {
        const newKey = 'lucy-' + Math.random().toString(36).substr(2, 9);
        document.getElementById('apiKey').value = newKey;
        updateEmbedCode(newKey);
    }

    function showToast(msg) {
        const toastEl = document.getElementById('saveToast');
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    // --- Load & Save ---
    async function loadSettings() {
        try {
            const res = await fetch(API_SETTINGS);
            if(!res.ok) throw new Error("Auth required");
            const data = await res.json();
            
            // Populate inputs
            document.getElementById('kbText').value = data.knowledge_base || "";
            document.getElementById('sysPrompt').value = data.system_prompt || "";
            document.getElementById('welcomeMsg').value = data.welcome_message || "";
            document.getElementById('apiKey').value = data.client_api_key || "lucy-dev-12345";
            document.getElementById('botName').value = data.bot_name || "Lucy AI";
            document.getElementById('themeColor').value = data.theme_color || "#4F46E5";
            document.getElementById('aiModel').value = data.model || "gemini-1.5-flash";
            document.getElementById('aiTemp').value = data.temperature || 0.7;
            document.getElementById('tempValue').innerText = data.temperature || 0.7;
            
            updatePreview(data);
            updateEmbedCode(data.client_api_key || "lucy-dev-12345");
            
            // Init chat
            addMsg(data.welcome_message || "Hello!", 'assistant');
        } catch(e) {
            window.location.href = '/auth';
        }
    }

    async function loadActivity() {
        try {
            const res = await fetch(API_ACTIVITY);
            const logs = await res.json();
            const container = document.getElementById('activityList');
            
            if (logs.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-4">No recent activity.</p>';
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div class="log-item">
                    <div class="log-query">${log.payload?.query || "Unknown Query"}</div>
                    <div class="log-meta">
                        <span class="badge bg-light text-dark border me-2">${new Date(log.timestamp * 1000).toLocaleTimeString()}</span>
                        <span class="text-success">${log.payload?.usage?.total_tokens || 0} tokens</span>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error("Activity load error", e);
        }
    }

    document.getElementById('saveBtn').addEventListener('click', async () => {
        const btn = document.getElementById('saveBtn');
        const oldText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;
        
        const config = {
            knowledge_base: document.getElementById('kbText').value,
            system_prompt: document.getElementById('sysPrompt').value,
            welcome_message: document.getElementById('welcomeMsg').value,
            client_api_key: document.getElementById('apiKey').value,
            bot_name: document.getElementById('botName').value,
            theme_color: document.getElementById('themeColor').value,
            model: document.getElementById('aiModel').value,
            temperature: document.getElementById('aiTemp').value
        };

        await fetch(API_SETTINGS, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });

        btn.innerText = oldText;
        btn.disabled = false;
        showToast("Configuration saved!");
        updatePreview(config);
    });

    // --- Preview Logic ---
    function updatePreview(config) {
        document.documentElement.style.setProperty('--primary-color', config.theme_color);
        document.getElementById('previewName').innerText = config.bot_name;
    }

    function addMsg(text, role) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.textContent = text;
        const container = document.getElementById('messages');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if(!text) return;
        
        addMsg(text, 'user');
        input.value = '';

        try {
            const res = await fetch(API_SUPPORT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': 'dashboard-demo-key' 
                },
                body: JSON.stringify({ user_query: text, language: 'auto', sector: 'admin' })
            });
            const data = await res.json();
            addMsg(data.reply, 'assistant');
        } catch(e) {
            addMsg("Connection error", 'assistant');
        }
    }

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('userInput').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') sendMessage();
    });

    // Live color preview
    document.getElementById('themeColor').addEventListener('input', (e) => {
        document.documentElement.style.setProperty('--primary-color', e.target.value);
    });
    document.getElementById('botName').addEventListener('input', (e) => {
        document.getElementById('previewName').innerText = e.target.value || "Lucy AI";
    });

    loadSettings();
</script>
</body>
</html>